name: Update Data Daily

on:
  schedule:
    # Ch·∫°y v√†o c√°c khung gi·ªù: 6h, 9h, 11h, 14h, 17h, 19h, 21h, 23h (gi·ªù VN, UTC+7)
    # V√Ä 0h UTC (7h s√°ng VN) ƒë·ªÉ c·∫≠p nh·∫≠t gi√° v√†ng
    - cron: '0 0,2,4 4,7,10,12,14,16,23 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MY_PAT }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies for Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          # T·∫£i v√† c√†i ƒë·∫∑t Chrome
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          # Ki·ªÉm tra phi√™n b·∫£n Chrome
          google-chrome --version

      - name: Install Python dependencies
        run: |
          pip install feedparser beautifulsoup4 requests selenium webdriver-manager

      - name: Run main update script
        run: python fetch_news.py

      - name: Display current time and schedule info
        run: |
          echo "Current UTC time: $(date -u '+%Y-%m-%d %H:%M:%S')"
          echo "Current Vietnam time: $(date -d '+7 hours' '+%Y-%m-%d %H:%M:%S')"
          echo "Gold price updates at 00:00 UTC (07:00 VN Time)"
          echo "This run was triggered by: ${{ github.event_name }}"

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ki·ªÉm tra v√† th√™m c√°c file JSON
          changed=false
          
          for file in news.json lottery.json giavang.json; do
            if [ -f "$file" ]; then
              git add "$file"
              echo "‚úì Added $file"
              changed=true
            else
              echo "‚ö†Ô∏è $file not found"
            fi
          done
          
          if [ "$changed" = true ]; then
            current_time_vn=$(date -d '+7 hours' '+%Y-%m-%d %H:%M:%S')
            
            # Ki·ªÉm tra tr·∫°ng th√°i gi√° v√†ng cho commit message
            gold_message=""
            if [ -f "giavang.json" ]; then
              gold_status=$(python -c "
import json
try:
    with open('giavang.json', 'r') as f:
        data = json.load(f)
    print(data.get('status', 'unknown'))
except:
    print('error')
              ")
              
              if [ "$gold_status" = "success" ]; then
                item_count=$(python -c "
import json
try:
    with open('giavang.json', 'r') as f:
        data = json.load(f)
    print(data.get('total_items', 0))
except:
    print('0')
                ")
                gold_message=" - Gold price updated ($item_count items)"
              elif [ "$gold_status" = "skipped" ]; then
                gold_message=" - Gold price skipped (not 7AM VN time)"
              fi
            fi
            
            commit_msg="ü§ñ Auto-update at $current_time_vn (VN Time)$gold_message"
            git commit -m "$commit_msg" || echo "No changes to commit"
            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "‚è≠Ô∏è No files to commit"
          fi
