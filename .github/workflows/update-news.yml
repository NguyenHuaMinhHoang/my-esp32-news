name: Update Data Daily

on:
  schedule:
    # Ch·∫°y v√†o c√°c khung gi·ªù: 6h, 9h, 11h, 14h, 17h, 19h, 21h, 23h (gi·ªù VN, UTC+7)
    # V√Ä th√™m 0h UTC (7h s√°ng VN) ƒë·ªÉ c·∫≠p nh·∫≠t gi√° v√†ng
    - cron: '0 0,2,4,7,10,12,14,16,23 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MY_PAT }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Install Python dependencies
        run: |
          pip install feedparser beautifulsoup4 requests selenium webdriver-manager

      - name: Run update script
        run: python fetch_news.py

      - name: Check current time
        run: |
          echo "Current UTC time: $(date -u)"
          echo "Current Vietnam time: $(date -d '+7 hours')"
          echo "Gold price updates at 00:00 UTC (07:00 VN Time)"

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ki·ªÉm tra file JSON
          files_to_add=""
          if [ -f "news.json" ]; then
            files_to_add="$files_to_add news.json"
            echo "üì∞ news.json t·ªìn t·∫°i"
          fi
          if [ -f "lottery.json" ]; then
            files_to_add="$files_to_add lottery.json"
            echo "üé± lottery.json t·ªìn t·∫°i"
          fi
          if [ -f "giavang.json" ]; then
            files_to_add="$files_to_add giavang.json"
            echo "ü™ô giavang.json t·ªìn t·∫°i"
          fi
          
          if [ ! -z "$files_to_add" ]; then
            git add $files_to_add
            git status
            
            # Ki·ªÉm tra xem c√≥ thay ƒë·ªïi kh√¥ng
            if ! git diff --staged --quiet; then
              current_time_vn=$(date -d '+7 hours' '+%Y-%m-%d %H:%M')
              commit_msg="ü§ñ Auto-update at $current_time_vn (VN Time)"
              
              # Th√™m th√¥ng tin chi ti·∫øt v√†o commit message
              if [ -f "giavang.json" ]; then
                gold_status=$(python -c "import json; data=json.load(open('giavang.json')); print(data.get('status', 'unknown'))")
                if [ "$gold_status" = "success" ]; then
                  commit_msg="$commit_msg - Gold price updated"
                fi
              fi
              
              git commit -m "$commit_msg"
              git push
              echo "‚úÖ ƒê√£ commit v√† push th√†nh c√¥ng!"
            else
              echo "‚è≠Ô∏è Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ commit"
            fi
          else
            echo "‚ùå Kh√¥ng t√¨m th·∫•y file JSON n√†o"
            exit 1
          fi
